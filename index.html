<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Academic Interface: Cognitive Response Analyzer v2.04</title>
    <!-- 教育用ライブラリとしてCDNから取得 -->
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        :root { --sys-gray: #f0f0f0; --sys-blue: #005a9e; --sys-text: #333; --border: #ababab; }
        body { background: var(--sys-gray); color: var(--sys-text); font-family: "Segoe UI", "Meiryo", sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 12px; }
        
        /* ツールバーの偽装 */
        #toolbar { display: flex; background: #fff; border-bottom: 1px solid var(--border); padding: 2px; }
        .menu-item { padding: 4px 12px; cursor: pointer; border: 1px solid transparent; }
        .menu-item:hover { background: #e5f1fb; border: 1px solid #a0c5e8; }
        .active-tab { background: #cce4f7; border: 1px solid #6094c7 !important; }

        /* 実験エリア（メイン） */
        #viewport { flex: 1; margin: 10px; background: #fff; border: 1px solid var(--border); display: flex; flex-direction: column; position: relative; box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1); }
        #status-bar { padding: 4px 10px; background: var(--sys-gray); border-bottom: 1px solid var(--border); font-size: 10px; color: #666; display: flex; justify-content: space-between; }
        #canvas { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: default; }
        
        /* ターゲット：ゲーム性を消した「データブロック」 */
        .data-unit { width: 44px; height: 44px; background: var(--sys-blue); position: absolute; cursor: crosshair; outline: 1px solid #000; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
        
        /* 計測数値 */
        #val-out { font-size: 42px; font-weight: 300; font-family: "Consolas", monospace; color: var(--sys-blue); }
        #info-log { font-size: 11px; margin-top: 5px; color: #888; }

        /* 統計パネル */
        #stats-panel { height: 220px; background: #fff; border-top: 1px solid var(--border); overflow-y: scroll; padding: 0; }
        .stats-table { width: 100%; border-collapse: collapse; }
        .stats-table th { position: sticky; top: 0; background: var(--sys-gray); border-bottom: 1px solid var(--border); padding: 5px; text-align: left; font-size: 10px; }
        .stats-table td { padding: 4px 8px; border-bottom: 1px solid #eee; font-family: "Consolas", monospace; font-size: 11px; }
        .row-even { background: #f9f9f9; }

        /* 設定ID */
        #subject-ref { position: absolute; bottom: 5px; right: 10px; font-size: 9px; color: #aaa; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div id="toolbar">
    <div class="menu-item active-tab" onclick="setTask('reflex')">Latency_Test</div>
    <div class="menu-item" onclick="setTask('burst')">Frequency_Analysis</div>
    <div class="menu-item" onclick="setTask('multi')">Parallel_Processing</div>
    <div class="menu-item" onclick="setTask('estimate')">Temporal_Interval</div>
</div>

<div id="viewport">
    <div id="status-bar">
        <span>Object ID: <span id="current-mode-name">REFLEX</span></span>
        <span>System Status: <span id="sys-status">Ready</span></span>
    </div>
    <div id="canvas">
        <div id="info-log">PRESS TO INITIALIZE SEQUENCE</div>
        <div id="val-out">0.0000</div>
    </div>
    <div id="subject-ref" onclick="modID()">Ref_ID: <span id="id-val">?</span></div>
</div>

<div id="stats-panel">
    <table class="stats-table" id="data-grid">
        <thead>
            <tr><th>RANK</th><th>SUBJECT_IDENTIFIER</th><th>METRICS_VALUE</th><th>TIMESTAMP</th></tr>
        </thead>
        <tbody id="grid-body">
            <tr><td colspan="4" style="text-align:center">Fetching Statistical Data...</td></tr>
        </tbody>
    </table>
</div>

<script>
const CONFIG = {
    URL: 'https://tcbtmngopvzwfsrnbzjz.supabase.co',
    KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjYnRtbmdvcHZ6d2Zzcm5iemp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NDE5MjksImV4cCI6MjA4NTUxNzkyOX0.WciQmMndyK71ao7CCe2LvfhbCl37u0OfkBisN17c'
};

let _api, mode = 'reflex', state = 'IDLE', mark, count = 0, timer, sid;

function startSystem() {
    try {
        _api = supabase.createClient(CONFIG.URL, CONFIG.KEY);
    } catch(e) {
        console.error("Network restriction detected.");
    }
    sid = localStorage.getItem('subj_id') || "S_" + Math.random().toString(36).substr(2, 5).toUpperCase();
    document.getElementById('id-val').innerText = sid;
    setTask('reflex');
}

function setTask(t) {
    clearTimeout(timer);
    mode = t; state = 'IDLE';
    document.querySelectorAll('.menu-item').forEach(m => {
        m.classList.toggle('active-tab', m.innerText.toLowerCase().includes(t.substring(0,3)));
    });
    document.getElementById('current-mode-name').innerText = t.toUpperCase();
    document.getElementById('canvas').style.background = '#fff';
    document.getElementById('val-out').innerText = 'START';
    document.getElementById('sys-status').innerText = 'Standby';
    refreshGrid();
}

async function uploadResult(v) {
    state = 'POST_PROC';
    document.getElementById('sys-status').innerText = 'Data Synchronizing...';
    document.getElementById('val-out').innerText = v.toFixed(4);
    if (_api) {
        await _api.from('global_ranking').insert([{ name: sid, score: v, mode: mode }]);
    }
    refreshGrid();
}

async function refreshGrid() {
    const body = document.getElementById('grid-body');
    if (!_api) return;
    const isAsc = (mode === 'reflex' || mode === 'estimate');
    const { data, error } = await _api.from('global_ranking').select('name, score, created_at').eq('mode', mode).order('score', { ascending: isAsc }).limit(15);
    
    if (error) {
        body.innerHTML = '<tr><td colspan="4" style="color:red">ERROR: SECURE_CONNECTION_FAILED (Filtering Active)</td></tr>';
        return;
    }

    body.innerHTML = '';
    data.forEach((r, i) => {
        const tr = document.createElement('tr');
        if (i % 2 === 1) tr.className = 'row-even';
        tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.score.toFixed(4)}</td><td>${new Date(r.created_at).toLocaleTimeString()}</td>`;
        body.appendChild(tr);
    });
}

function spawnUnit() {
    if (state !== 'ACTIVE') return;
    const canvas = document.getElementById('canvas');
    const unit = document.createElement('div');
    unit.className = 'data-unit';
    unit.style.left = Math.random() * (canvas.clientWidth - 50) + 'px';
    unit.style.top = Math.random() * (canvas.clientHeight - 50) + 'px';
    unit.onpointerdown = (e) => { e.stopPropagation(); count++; unit.remove(); spawnUnit(); };
    canvas.appendChild(unit);
}

document.getElementById('canvas').onpointerdown = () => {
    const canvas = document.getElementById('canvas');
    if (state === 'IDLE' || state === 'POST_PROC') {
        if (mode === 'multi') {
            state = 'ACTIVE'; count = 0;
            document.getElementById('val-out').innerText = '';
            for(let i=0; i<4; i++) spawnUnit();
            timer = setTimeout(() => { document.querySelectorAll('.data-unit').forEach(u => u.remove()); uploadResult(count); }, 30000);
        } else if (mode === 'burst') {
            state = 'ACTIVE'; count = 1;
            timer = setTimeout(() => uploadResult(count), 4000);
        } else if (mode === 'reflex') {
            state = 'WAITING'; document.getElementById('val-out').innerText = '...';
            timer = setTimeout(() => { 
                state = 'ACTIVE'; mark = Date.now(); 
                canvas.style.background = '#e1f5fe';
                document.getElementById('val-out').innerText = 'SIGNAL'; 
            }, Math.random()*3000+2000);
        } else if (mode === 'estimate') {
            state = 'ACTIVE'; mark = Date.now();
            document.getElementById('val-out').innerText = 'TIMER_RUN';
        }
        document.getElementById('sys-status').innerText = 'Processing...';
    } else if (state === 'ACTIVE') {
        if (mode === 'reflex') uploadResult((Date.now()-mark)/1000);
        if (mode === 'burst') { count++; document.getElementById('val-display').innerText = count; }
        if (mode === 'estimate') uploadResult(Math.abs(10-(Date.now()-mark)/1000));
    }
};

function modID() {
    let n = prompt("Change Subject_Identifier:", sid);
    if(n) { sid = n; localStorage.setItem('subj_id', n); document.getElementById('id-val').innerText = n; }
}

startSystem();
</script>
</body>
</html>
